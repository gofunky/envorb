version: 2.1

orbs:
  orb-tools: circleci/orb-tools@volatile

master_filter: &master_filter
  filters:
    branches:
      only:
        - master

workflows:
  build_latest:
    jobs:
      - orb-tools/pack:
          name: validate_orb
          <<: *master_filter
          source-dir: ./src/
          destination-orb-path: ./packed/orb.yml
          workspace-path: ./packed/orb.yml
          artifact-path: ./packed/orb.yml
      - orb-tools/publish:
          name: publish_orb
          <<: *master_filter
          context: orb-tools
          orb-ref: "gofunky/envorb@dev:${CIRCLE_BRANCH}"
          publish-token-variable: "$ORB_PUBLISHING_TOKEN"
          orb-path: packed/orb.yml
          attach-workspace: true
          checkout: false
          requires:
            - validate_orb
      - orb-tools/increment:
          name: increment_orb
          <<: *master_filter
          context: orb-tools
          segment: patch
          orb-ref: gofunky/envorb
          publish-token-variable: "$ORB_PUBLISHING_TOKEN"
          orb-path: packed/orb.yml
          attach-workspace: true
          checkout: false
          requires:
            - publish_orb
  #build_release:
  #  jobs:
  #    - envorb/git_tag:
  #        name: release_tag
  #        <<: *tag_filter
  #        alpine_version: "3.8"
  #        variable: TAG_VERSION
  #    - dockerorb/build_test_push:
  #        name: build_release
  #        <<: *readmyhub_job
  #        <<: *tag_filter
  #        attach: true
  #        use_args: true
  #        args: "VERSION=${TAG_VERSION}"
  #        tags: "gofunky/readmyhub:stable,gofunky/readmyhub:${TAG_VERSION}"
  #        requires:
  #          - release_tag
  #    - dockerorb/build_test_push:
  #        name: build_git_release
  #        <<: *readmyhub_job
  #        <<: *tag_filter
  #        attach: true
  #        file: "Dockerfile.git"
  #        use_args: true
  #        args: "BASE_VERSION=${TAG_VERSION}"
  #        tags: "gofunky/readmyhub:stable-git,gofunky/readmyhub:${TAG_VERSION}-git"
  #        requires:
  #          - build_release
  #          - release_tag
